<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <div class="card shadow-sm">
        <div class="card-body">

          <h1 class="card-title mb-4">新規クエスト作成</h1>

          <%= form_with(model: @quest, local: true) do |f| %>

            <!-- ▼ 大分類カテゴリ ▼ -->
            <div class="mb-3">
              <%= f.label :category, "カテゴリ（大分類）", class: "form-label" %>
              <%= f.select :category,
                [
                  ["勉強・学習", "勉強・学習"],
                  ["家事・生活", "家事・生活"],
                  ["仕事・作業", "仕事・作業"],
                  ["健康・フィットネス", "健康・フィットネス"],
                  ["用事・手続き", "用事・手続き"],
                  ["自己管理", "自己管理"],
                  ["趣味・創作", "趣味・創作"],
                  ["人間関係・コミュニケーション", "人間関係・コミュニケーション"],
                  ["金銭管理", "金銭管理"],
                  ["メンタルケア", "メンタルケア"],
                  ["外出・移動", "外出・移動"],
                  ["雑務（その他）", "雑務（その他）"]
                ],
                { prompt: "選択してください" },
                class: "form-control",
                id: "category_select"
              %>
            </div>

            <!-- ▼ 小分類カテゴリ ▼ -->
            <div class="mb-3">
              <%= f.label :subcategory, "サブカテゴリ（小分類）", class: "form-label" %>
              <%= f.select :subcategory,
                [],
                { prompt: "先にカテゴリを選んでください" },
                class: "form-control",
                id: "subcategory_select"
              %>
            </div>

            <!-- ▼ 難易度（時間スライダー） ▼ -->
            <div class="mb-3">
              <label class="form-label">所要時間（目安）</label>

              <%= f.hidden_field :difficulty, id: "difficulty_field" %>

              <input type="range"
                     class="form-range"
                     id="time_slider"
                     min="0"
                     max="120"
                     step="5"
                     value="30">

              <div class="mt-2">
                <strong id="time_label">30分</strong>
              </div>
              <div class="mt-1">
                <span id="difficulty_label">難易度：初級</span>
              </div>
              <div class="text-muted small mt-1" id="difficulty_desc">
                ～30分｜軽いタスク
              </div>
            </div>

            <!-- ▼ 期限（追加） ▼ -->
            <div class="mb-3">
              <%= f.label :due_date, "期限（任意）", class: "form-label" %>
              <%= f.date_field :due_date, class: "form-control" %>
              <small class="form-text">
                未設定の場合は「期限なし」として扱われます
              </small>
            </div>

            <!-- ▼ タイトル ▼ -->
            <div class="mb-3">
              <%= f.label :title, "タイトル", class: "form-label" %>
              <%= f.text_field :title, class: "form-control", id: "title_field" %>
            </div>

            <!-- ▼ 説明文 ▼ -->
            <div class="mb-3">
              <%= f.label :description, "説明文", class: "form-label" %>
              <%= f.text_area :description, rows: 5, class: "form-control" %>
            </div>

            <!-- ▼ ボタン ▼ -->
            <div class="d-flex justify-content-between mt-4">
              <%= link_to "一覧へ戻る", quests_path, class: "btn btn-secondary" %>
              <%= f.submit "作成する", class: "btn btn-warning" %>
            </div>

          <% end %>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const SUBCATEGORIES = {
    "勉強・学習": ["予習", "復習", "試験対策", "語学", "資格", "課題"],
    "家事・生活": ["掃除", "洗濯", "料理", "買い物", "整理整頓", "ゴミ出し"],
    "仕事・作業": ["資料作成", "会議準備", "調査", "メール処理", "報告書"],
    "健康・フィットネス": ["散歩", "筋トレ", "ストレッチ", "ランニング", "ヨガ"],
    "用事・手続き": ["病院", "役所", "銀行", "郵便", "買い出し"],
    "自己管理": ["スケジュール整理", "目標設定", "日記", "片付け", "睡眠管理"],
    "趣味・創作": ["音楽", "絵", "プログラミング", "ゲーム制作", "読書", "動画編集"],
    "人間関係・コミュニケーション": ["友人との約束", "家族ケア", "連絡", "プレゼント準備"],
    "金銭管理": ["家計簿", "支払い", "貯金", "資産管理"],
    "メンタルケア": ["瞑想", "深呼吸", "休息", "リフレッシュ"],
    "外出・移動": ["買い物", "散歩", "通学", "通勤"],
    "雑務（その他）": ["その他"]
  };

  const categorySelect = document.getElementById("category_select");
  const subSelect = document.getElementById("subcategory_select");
  const titleField = document.getElementById("title_field");

  function updateTitle() {
    const c = categorySelect.value || "";
    const s = subSelect.value || "";
    if (c && s) {
      titleField.value = `${c}：${s}`;
    } else if (c) {
      titleField.value = c;
    }
  }

  categorySelect.addEventListener("change", function () {
    const category = this.value;

    subSelect.innerHTML = "";

    const prompt = document.createElement("option");
    prompt.value = "";
    prompt.textContent = "先にカテゴリを選んでください";
    subSelect.appendChild(prompt);

    if (SUBCATEGORIES[category]) {
      SUBCATEGORIES[category].forEach(sub => {
        const option = document.createElement("option");
        option.value = sub;
        option.textContent = sub;
        subSelect.appendChild(option);
      });
    }

    updateTitle();
  });

  subSelect.addEventListener("change", updateTitle);

  // ▼ スライダー処理
  const slider = document.getElementById("time_slider");
  const timeLabel = document.getElementById("time_label");
  const diffLabel = document.getElementById("difficulty_label");
  const diffDesc  = document.getElementById("difficulty_desc");
  const diffField = document.getElementById("difficulty_field");

  function updateDifficulty(val) {
    let diff, desc, timeText;

    if (val <= 30) {
      diff = "初級";
      desc = "～30分｜軽いタスク";
      timeText = `${val}分`;
    } else if (val <= 60) {
      diff = "中級";
      desc = "～60分｜集中が必要";
      timeText = `${val}分`;
    } else if (val < 120) {
      diff = "上級";
      desc = "～120分｜しっかり作業";
      timeText = `${val}分`;
    } else {
      diff = "超上級";
      desc = "120分以上｜覚悟がいる";
      timeText = "120分以上";
    }

    timeLabel.textContent = timeText;
    diffLabel.textContent = `難易度：${diff}`;
    diffDesc.textContent  = desc;
    diffField.value = diff;
  }

  slider.addEventListener("input", e => {
    updateDifficulty(parseInt(e.target.value, 10));
  });

  updateDifficulty(parseInt(slider.value, 10));
</script>
